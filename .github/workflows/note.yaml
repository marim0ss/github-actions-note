name: Note Workflow

on:
  workflow_dispatch:
    inputs:
      theme:
        description: '記事テーマ'
        required: true
        type: string
      target:
        description: '想定読者（ペルソナ）'
        required: true
        type: string
      message:
        description: '読者に伝えたい核メッセージ'
        required: true
        type: string
      cta:
        description: '読後のアクション（CTA）'
        required: true
        type: string
      tags:
        description: 'カンマ区切りタグ（任意）'
        required: false
        default: ''
        type: string
      is_public:
        description: '公開(true)/下書き(false)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: '投稿をスキップ（生成のみ）'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

env:
  TZ: Asia/Tokyo

jobs:
  research:
    name: Research (Anthropic SDK + Web Tools)
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      THEME: ${{ github.event.inputs.theme }}
      TARGET: ${{ github.event.inputs.target }}
    outputs:
      research_b64: ${{ steps.collect.outputs.research_b64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Anthropic SDK
        run: |
          npm init -y
          npm i @anthropic-ai/sdk

      - name: Research with Latest Anthropic SDK
        run: |
          cat > research.mjs <<'EOF'
          import Anthropic from '@anthropic-ai/sdk';
          import fs from 'fs';

          const anthropic = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY,
          });

          const theme = process.env.THEME || 'テストテーマ';
          const target = process.env.TARGET || 'テストターゲット';
          const today = new Date().toISOString().slice(0,10);
          const artifactsDir = '.note-artifacts';
          fs.mkdirSync(artifactsDir, { recursive: true });

          const response = await anthropic.messages.create({
            model: "claude-sonnet-4-5-20250929",  // ←これが正しい！（Claude 4.5 Sonnet、2025年9月版）
            max_tokens: 8192,
            temperature: 0.7,
            system: `あなたは最新情報の収集と要約に特化した超一流のリサーチャーです。
            事実ベース・一次情報優先・本文内にMarkdownリンクで出典を必ず埋め込むこと。
            十分な分量（目安: 2,500語以上）で詳細に書いてください。
            Web検索ツールを積極的に使い、一次情報（公的機関・論文・公式発表）を最優先にしてください。
            現在日付: ${today}`,
            messages: [{
              role: "user",
              content: `以下のテーマとターゲットに対する最終版のリサーチレポートを作成してください。
              【重要】途中経過や確認質問は一切せず、最終レポートのみ返してください。
              不明点は「前提と仮定」セクションで簡潔に明記してから続行してください。
              ---
              テーマ: ${theme}
              ターゲット: ${target}
              現在日付: ${today}`
            }],
            tools: [
              {
                type: "web_search_20250305",  // 2025年最新のWebSearchツールタイプ
                name: "web_search"
              }
            ],
            tool_choice: { type: "auto" }  // 自動でツール使用
          });

          let finalText = '';
          for (const block of response.content) {
            if (block.type === 'text') {
              finalText += block.text + '\n\n';
            }
          }

          // ツール使用のトレースも保存（デバッグ用）
          const trace = {
            usage: response.usage,
            content: response.content
          };

          fs.writeFileSync(`${artifactsDir}/research.md`, finalText.trim());
          fs.writeFileSync(`${artifactsDir}/research_trace.json`, JSON.stringify(trace, null, 2));
          console.log("リサーチ完了！生成文字数約:", finalText.length);
          EOF

          node research.mjs

      - name: Collect research
        id: collect
        run: |
          b64=$(base64 -w 0 .note-artifacts/research.md 2>/dev/null || base64 .note-artifacts/research.md)
          echo "research_b64<<EOF" >> $GITHUB_OUTPUT
          echo "$b64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload research artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-artifacts
          path: |
            .note-artifacts/research.md
            .note-artifacts/research_trace.json

  write:
    name: Write (Claude Sonnet 4.0)
    needs: research
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      THEME: ${{ github.event.inputs.theme }}
      TARGET: ${{ github.event.inputs.target }}
      MESSAGE: ${{ github.event.inputs.message }}
      CTA: ${{ github.event.inputs.cta }}
      INPUT_TAGS: ${{ github.event.inputs.tags }}
    outputs:
      title: ${{ steps.collect.outputs.title }}
      draft_json_b64: ${{ steps.collect.outputs.draft_json_b64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore research
        env:
          RESEARCH_B64: ${{ needs.research.outputs.research_b64 }}
        run: |
          mkdir -p .note-artifacts
          echo "$RESEARCH_B64" | base64 -d > .note-artifacts/research.md || echo "$RESEARCH_B64" | base64 --decode > .note-artifacts/research.md

      - name: Ultra-light write (絶対死なない最終版)
        run: |
          cat > ultra_write.mjs <<'EOF'
          import fs from 'fs';

          // research.md の最初の 8000 文字だけ使う（これで確実に30,000制限内）
          const researchHead = fs.readFileSync('.note-artifacts/research.md','utf8')
            .substring(0, 8000);

          const prompt = `以下の情報だけを使って、note.com向け長文記事を1発で書いてください。
          必ずこのJSON形式で返答：
          {"title":"タイトル","draftBody":"6000-9000文字の本文","tags":["タグ1","タグ2"]}

          【テーマ】${process.env.THEME}
          【ペルソナ】${process.env.TARGET}
          【伝えたいこと】${process.env.MESSAGE}
          【読後のアクション】${process.env.CTA}
          【リサーチ抜粋（冒頭8000文字）】
          ${researchHead}

          小見出しと箇条書きを多用して読みやすく。`;

          const res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01',
              'content-type': 'application/json'
            },
            body: JSON.stringify({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 8192,
              temperature: 0.7,
              system: 'あなたは優秀なライターです。指示されたJSON形式でだけ返答してください。',
              messages: [{ role: 'user', content: prompt }]
            })
          });

          if (!res.ok) {
            console.error('API Error:', await res.text());
            process.exit(1);
          }

          const data = await res.json();
          const text = data.content?.[0]?.text || '';

          const jsonMatch = text.match(/\{[\s\S]*\}/);
          let result = { title: '最終手段タイトル', draftBody: text, tags: [] };
          if (jsonMatch) {
            try { result = JSON.parse(jsonMatch[0]); } catch (e) { console.log('JSON parse失敗', e); }
          }

          // タイトルが空なら強制補完
          if (!result.title || result.title.trim() === '') {
            result.title = (result.draftBody || '').split('\n')[0]?.replace(/^#*\s*/, '').slice(0,80) || 'note記事';
          }

          // タグ追加
          const inputTags = (process.env.INPUT_TAGS||'').split(',').map(s=>s.trim()).filter(Boolean);
          if (inputTags.length) {
            result.tags = Array.from(new Set([...(Array.isArray(result.tags)?result.tags:[]), ...inputTags]));
          }

          fs.writeFileSync('.note-artifacts/draft.json', JSON.stringify(result, null, 2));
          console.log('Ultra-light Write 成功！タイトル:', result.title);
          EOF

          node ultra_write.mjs

      - name: Collect draft
        id: collect
        run: |
          title=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.note-artifacts/draft.json','utf8')).title)")
          b64=$(base64 -w 0 .note-artifacts/draft.json 2>/dev/null || base64 .note-artifacts/draft.json)
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$title" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "draft_json_b64<<EOF" >> $GITHUB_OUTPUT
          echo "$b64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload draft artifact
        uses: actions/upload-artifact@v4
        with:
          name: draft-artifact
          path: .note-artifacts/draft.json
